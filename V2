import subprocess
import json
import time
from pathlib import Path
from TikTokApi import TikTokApi

VIDEOS_DIR = Path("clips")
LOG_FILE = Path("videos_subidos.json")
DEFAULT_TITLE = "ðŸŽ¬ Nuevo clip #gaming #fun"

# Cargar videos ya subidos
if LOG_FILE.exists():
    with open(LOG_FILE, "r") as f:
        uploaded_videos = set(json.load(f))
else:
    uploaded_videos = set()

# Inicializar TikTokApi
api = TikTokApi()

print("ðŸš€ Iniciando monitor de clips...")

def get_video_duration(video_path):
    """Devuelve la duraciÃ³n del video en segundos usando ffprobe."""
    result = subprocess.run(
        ["ffprobe", "-v", "error", "-show_entries",
         "format=duration", "-of",
         "default=noprint_wrappers=1:nokey=1", str(video_path)],
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT
    )
    try:
        return float(result.stdout)
    except:
        return 0

while True:
    for video_path in VIDEOS_DIR.glob("*.mp4"):
        if str(video_path) in uploaded_videos:
            continue

        duration = get_video_duration(video_path)
        if duration < 60:
            print(f"{video_path.name} es menor a 1 minuto, se ignora")
            continue

        # Subir video a TikTok
        try:
            print(f"Subiendo {video_path.name} a TikTok...")
            api.upload_video(video_path, caption=DEFAULT_TITLE)
            print(f"âœ… {video_path.name} subido exitosamente!")

            uploaded_videos.add(str(video_path))
            with open(LOG_FILE, "w") as f:
                json.dump(list(uploaded_videos), f)

        except Exception as e:
            print(f"Error al subir {video_path.name}: {e}")

    time.sleep(10)